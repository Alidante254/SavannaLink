<!-- dashboard.html -->

{% extends 'base.html' %}

{% load static %}

{% block title %}Dashboard - SavannahLink{% endblock %}
<head>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
{% block content %}
    <div class="container mt-5">
        <h1 class="text-center">Dashboard</h1>
        <p class="text-center">Welcome, {{ username }}!</p>

        <div class="container-fluid">
            <div class="row py-3 border-bottom">
                <div class="col-sm-6 offset-sm-2 offset-md-0 col-lg-5 d-none d-lg-block">
                    <div class="search-bar row bg-light p-2 my-2 rounded-4">
                        <div class="col-md-4 d-none d-md-block">
                            <select class="form-select border-0 bg-transparent">
                                <option>All Categories</option>
                                <option>Crops</option>
                                <option>Livestock</option>
                                <option>Equipment</option>
                            </select>
                        </div>
                        <div class="col-11 col-md-7">
                            <form id="search-form" class="text-center" action="#" method="post">
                                <input type="text" class="form-control border-0 bg-transparent" placeholder="Search for agricultural products" />
                            </form>
                        </div>
                        <div class="col-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0a1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 7-7a7 7 0 0 1-7 7Z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="col-sm-8 col-lg-4 d-flex justify-content-end gap-5 align-items-center mt-4 mt-sm-0 justify-content-center justify-content-sm-end ms-auto">
                    <div class="support-box text-end d-none d-xl-block">
                        <span class="fs-6 text-muted">For Support?</span>
                        <h5 class="mb-0">+254 703527474</h5>
                    </div>
                
                    <ul class="d-flex justify-content-end list-unstyled m-0">
                        <li>
                            <a href="#" class="rounded-circle bg-light p-2 mx-1">
                                <img src="{% static 'images/user.png' %}" alt="account" width="24" height="24">
                            </a>
                        </li>
                        <li>
                            <a href="#" class="rounded-circle bg-light p-2 mx-1">
                                <img src="{% static 'images/heart.png' %}" alt="favourites" width="24" height="24">
                            </a>
                        </li>
                        <li class="d-lg-none">
                            <a href="#" class="rounded-circle bg-light p-2 mx-1" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart">
                                <img src="{% static 'images/shopping-cart.png' %}" alt="cart" width="24" height="24">
                            </a>
                        </li>
                        <li class="d-lg-none">
                            <a href="#" class="rounded-circle bg-light p-2 mx-1" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSearch" aria-controls="offcanvasSearch">
                                <img src="{% static 'images/search.png' %}" alt="cart" width="24" height="24">
                            </a>
                        </li>
                    </ul>
                
                    <div class="cart text-end d-none d-lg-block dropdown">
                        <button class="border-0 bg-transparent d-flex flex-column gap-2 lh-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart">
                            <span class="fs-6 text-muted dropdown-toggle">Your Cart</span>
                    
                            {% if cart_items %}
                                <span class="cart-total fs-5 fw-bold">${{ cart_total }}</span>
                                {% for item in cart_items %}
                                    <p>{{ item.product.name }} - Quantity: <span id="quantity-{{ item.product.id }}">{{ item.quantity }}</span></p>
                                    <!-- Add buttons to increase and decrease quantity -->
                                    <button class="quantity-increase" data-product-id="{{ item.product.id }}">Increase</button>
                                    <button class="quantity-decrease" data-product-id="{{ item.product.id }}">Decrease</button>
                                {% endfor %}
                            {% else %}
                                <span class="cart-total fs-5 fw-bold">$0.00</span>
                                <p>Your cart is empty.</p>
                            {% endif %}
                    
                        </button>
                    </div>
                    
                </div>                
            </div>


            <div class="row py-3">
                <div class="d-flex justify-content-center justify-content-sm-between align-items-center">
                    <nav class="main-menu d-flex navbar navbar-expand-lg">
        
                        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
        
                            <div class="offcanvas-header justify-content-center">
                                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                            </div>
        
                            <div class="offcanvas-body">
        
                                <select class="filter-categories border-0 mb-0 me-5">
                                    <option>Shop by Departments</option>
                                    <option>Crops</option>
                                    <option>Livestock</option>
                                    <option>Equipment</option>
                                </select>
        
                                <ul class="navbar-nav justify-content-end menu-list list-unstyled d-flex gap-md-3 mb-0">
                                    <li class="nav-item active">
                                        <a href="#crops" class="nav-link">Crops</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#livestock" class="nav-link">Livestock</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#equipment" class="nav-link">Equipment</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#brand" class="nav-link">Brand</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#sale" class="nav-link">Sale</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#blog" class="nav-link">Blog</a>
                                    </li>
                                </ul>
        
                            </div>
        
                        </div>
        
                    </nav>
                    <div class="d-none d-lg-block">
                        <a href="#" target="_blank" class="nav-link btn-coupon-code">
                            <img src="{% static 'images/giftbox.png' %}" alt="gift icon" width="20px" height="20px">
                            <strong class="ms-2 text-dark">Special Offers</strong>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add other dashboard content as needed -->
        <div class="banner-ad large bg-info block-1">
            <div class="row banner-content p-5">
                <div class="content-wrapper col-md-7">
                    <div class="categories my-3">Fresh from the Farm</div>
                    <h3 class="display-4">Quality Agricultural Products</h3>
                    <p>Explore a wide range of fresh and organic agricultural products directly from local farms. Cultivated with care and dedication.</p>
                    <a href="#" class="btn btn-outline-dark btn-lg text-uppercase fs-6 rounded-1 px-4 py-3 mt-3">Shop Now</a>
                </div>
                <div class="img-wrapper col-md-5">
                    <img src="https://th.bing.com/th/id/R.954fc4e473e26a369d6fb8146cae8cf1?rik=OtGxq0xxiMCzFA&pid=ImgRaw&r=0" alt="Agricultural Product" class="img-fluid">
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="bootstrap-tabs product-tabs">
                        <!-- ... (existing code) ... -->
        
                        <div class="tab-content" id="nav-tabContent">
                            <div class="tab-pane fade show active" id="nav-all" role="tabpanel" aria-labelledby="nav-all-tab">
                                <div class="product-grid row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5">
                                    {% for product in products %}
                                    <div class="col">
                                        <div class="product-item">
                                            <a href="#" class="btn-wishlist"><svg width="24" height="24"><use xlink:href="#heart"></use></svg></a>
                                            <figure>
                                                <a href="{% url 'product_detail' product.id %}" title="{{ product.name }}">
                                                    <img src="{{ product.image.url }}" class="tab-image" alt="{{ product.name }}">
                                                </a>
                                            </figure>
                                            <h3>{{ product.name }}</h3>
                                            <span class="qty">{{ product.quantity }}</span>
                                            <span class="rating">
                                                {% for _ in "x"|ljust:product.rating %}
                                                <svg width="16" height="16" class="text-primary">
                                                    <use xlink:href="#star-solid"></use>
                                                </svg>
                                                {% endfor %}
                                            </span>
                                            <span class="price">${{ product.price }}</span>
                                            <div class="d-flex align-items-center justify-content-between">
                                                <div class="input-group product-qty">
                                                    <span class="input-group-btn">
                                                        <button type="button" class="quantity-left-minus btn btn-danger btn-number" data-type="minus">
                                                            <svg width="16" height="16"><use xlink:href="#minus"></use></svg>
                                                        </button>
                                                    </span>
                                                    <input type="text" id="quantity" name="quantity" class="form-control input-number" value="1">
                                                    <span class="input-group-btn">
                                                        <button type="button" class="quantity-right-plus btn btn-success btn-number" data-type="plus">
                                                            <svg width="16" height="16"><use xlink:href="#plus"></use></svg>
                                                        </button>
                                                    </span>
                                                </div>
                                                <a href="#" class="nav-link">Add to Cart <iconify-icon icon="uil:shopping-cart"></iconify-icon></a>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Function to handle quantity changes
            function updateQuantity(productId, newQuantity) {
                // Send an AJAX request to update the quantity in the backend
                $.ajax({
                    type: 'POST',
                    url: '{% url "update_cart" %}',  // Replace with your Django URL endpoint for updating the cart
                    data: {
                        'product_id': productId,
                        'quantity': newQuantity,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'  // Include the CSRF token for security
                    },
                    success: function (data) {
                        // Update the displayed quantity on success
                        $('#quantity-' + productId).text(newQuantity);
                        // You can also update the total or perform other actions here
                    },
                    error: function () {
                        alert('Error updating quantity. Please try again.');
                    }
                });
            }
    
            // Event listener for increasing quantity
            $('.quantity-increase').click(function () {
                var productId = $(this).data('product-id');
                var currentQuantity = parseInt($('#quantity-' + productId).text());
                var newQuantity = currentQuantity + 1;
                updateQuantity(productId, newQuantity);
            });
    
            // Event listener for decreasing quantity
            $('.quantity-decrease').click(function () {
                var productId = $(this).data('product-id');
                var currentQuantity = parseInt($('#quantity-' + productId).text());
                var newQuantity = Math.max(currentQuantity - 1, 0);  // Ensure quantity doesn't go below 0
                updateQuantity(productId, newQuantity);
            });
        });
    </script>
{% endblock %}